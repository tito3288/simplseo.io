rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read/write their own onboarding data
    match /onboarding/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read/write their own user data (including GSC tokens)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read/write their own GSC tokens
    match /gscTokens/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read/write their own implemented SEO tips
    match /implementedSeoTips/{docId} {
      allow read, write: if request.auth != null && (
        // New format: check userId field
        (resource.data.userId == request.auth.uid) ||
        // Old format: check if document ID starts with user ID
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Allow users to read/write their own internal link suggestions
    match /internalLinkSuggestions/{docId} {
      allow read, write: if request.auth != null && (
        // New format: check userId field
        (resource.data.userId == request.auth.uid) ||
        // Old format: check if document ID starts with user ID
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Allow users to read/write their own intent mismatches
    match /intentMismatches/{docId} {
      allow read, write: if request.auth != null && (
        // New format: check userId field
        (resource.data.userId == request.auth.uid) ||
        // Old format: check if document ID starts with user ID
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Allow users to read/write their own page content cache (backward-compatible)
    // NEW structure: pageContentCache/{userId}/pages/{pageUrl}
    match /pageContentCache/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /pages/{pageUrl} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // OLD structure: pageContentCache/{userId}_{pageUrl} (backward compatibility)
    match /pageContentCache/{docId} {
      allow read, write: if request.auth != null && (
        // Check if document ID starts with user ID (old format)
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Allow users to read/write their own intent mismatches (backward-compatible)
    // NEW structure: intentMismatches/{userId}/analyses/{cacheKey}
    match /intentMismatches/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /analyses/{cacheKey} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // OLD structure: intentMismatches/{cacheKey} (backward compatibility)
    match /intentMismatches/{docId} {
      allow read, write: if request.auth != null && (
        // New format: check userId field
        (resource.data.userId == request.auth.uid) ||
        // Old format: check if document ID starts with user ID
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Allow users to read/write their own meta titles (backward-compatible)
    // NEW structure: seoMetaTitles/{userId}/titles/{cacheKey}
    match /seoMetaTitles/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /titles/{cacheKey} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // OLD structure: seoMetaTitles/{cacheKey} (backward compatibility)
    match /seoMetaTitles/{cacheKey} {
      allow read, write: if request.auth != null && (
        // Check userId field if exists, or allow if no userId field (legacy data)
        (!('userId' in resource.data)) || 
        (resource.data.userId == request.auth.uid)
      );
    }
    
    // Allow users to read/write their own meta descriptions (backward-compatible)
    // NEW structure: seoMetaDescriptions/{userId}/descriptions/{cacheKey}
    match /seoMetaDescriptions/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      match /descriptions/{cacheKey} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // OLD structure: seoMetaDescriptions/{cacheKey} (backward compatibility)
    match /seoMetaDescriptions/{cacheKey} {
      allow read, write: if request.auth != null && (
        // Check userId field if exists, or allow if no userId field (legacy data)
        (!('userId' in resource.data)) || 
        (resource.data.userId == request.auth.uid)
      );
    }
    
    // Allow users to read/write their own content audit results
    match /contentAuditResults/{docId} {
      allow read, write: if request.auth != null && (
        // New format: check userId field
        (resource.data.userId == request.auth.uid) ||
        // Old format: check if document ID starts with user ID
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Allow users to read/write their own AI suggestions
    match /aiSuggestions/{docId} {
      allow read, write: if request.auth != null && (
        // New format: check userId field
        (resource.data.userId == request.auth.uid) ||
        // Old format: check if document ID starts with user ID
        (docId.matches(request.auth.uid + '_.*'))
      );
    }
    
    // Training events - server-side only (no client access)
    match /trainingEvents/{hashedUserId} {
      allow read: if false; // No client reads
      allow write: if false; // Server-side only
      
      match /events/{eventId} {
        allow read: if false;
        allow write: if false;
      }
    }
    
    // Playbook strategies - server-side only (no client access)
    match /playbookStrategies/{hashedUserId} {
      allow read: if false; // No client reads
      allow write: if false; // Server-side only
      
      match /strategies/{strategyId} {
        allow read: if false;
        allow write: if false;
      }
    }
    
    // Conversation summaries - server-side only (no client access)
    match /conversationSummaries/{hashedUserId} {
      allow read: if false; // No client reads
      allow write: if false; // Server-side only
      
      match /summaries/{summaryId} {
        allow read: if false;
        allow write: if false;
      }
    }
    
    // App config - server-side only (no client access)
    match /appConfig/{configId} {
      allow read: if false; // No client reads
      allow write: if false; // Server-side only
    }
  }
} 